// src/home/CustomNavigation.test.tsx
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import { MemoryRouter } from 'react-router-dom';
import CustomNavigation from './CustomNavigation';

// Spy navigate
const navigateMock = jest.fn();
jest.mock('react-router-dom', () => {
  const actual = jest.requireActual('react-router-dom');
  return {
    __esModule: true,
    ...actual,
    useNavigate: () => navigateMock,
  };
});

const renderAt = (path: string) =>
  render(
    <MemoryRouter initialEntries={[path]}>
      <CustomNavigation />
    </MemoryRouter>
  );

// anchor query (why: <a> has no href, so no "link" role)
const getA = (label: RegExp) => screen.getByText(label, { selector: 'a' });

describe('CustomNavigation', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  test('home route shows only Home link and marks it active', () => {
    renderAt('/home');

    const home = getA(/^home$/i);
    expect(home).toBeInTheDocument();
    expect(home).toHaveClass('nav-link');
    expect(home).toHaveClass('nav-link-active');
    // exactly one nav anchor
    expect(document.querySelectorAll('a.nav-link').length).toBe(1);

    fireEvent.click(home);
    expect(navigateMock).toHaveBeenCalledWith('/home');
  });

  test('/provision shows Home + Environment Provisioning; active is /provision', () => {
    renderAt('/provision');

    const home = getA(/^home$/i);
    const envProv = getA(/environment provisioning/i);

    expect(home).toBeInTheDocument();
    expect(envProv).toBeInTheDocument();

    expect(envProv).toHaveClass('nav-link-active');
    expect(home).not.toHaveClass('nav-link-active');

    fireEvent.click(home);
    fireEvent.click(envProv);
    expect(navigateMock).toHaveBeenCalledWith('/home');
    expect(navigateMock).toHaveBeenCalledWith('/provision');
  });

  test('/gcpOnboarding shows Home + Onboarding Form + Onboarding Request; active is Onboarding Form', () => {
    renderAt('/gcpOnboarding');

    const home = getA(/^home$/i);
    const form = getA(/onboarding form/i);
    const request = getA(/onboarding request/i);

    expect(home).toBeInTheDocument();
    expect(form).toBeInTheDocument();
    expect(request).toBeInTheDocument();

    expect(form).toHaveClass('nav-link-active');
    expect(home).not.toHaveClass('nav-link-active');
    expect(request).not.toHaveClass('nav-link-active');

    fireEvent.click(form);
    fireEvent.click(request);
    expect(navigateMock).toHaveBeenCalledWith('/gcpOnboarding');
    expect(navigateMock).toHaveBeenCalledWith('/inbox');
  });

  test('/inbox shows Home + Onboarding Form + Onboarding Request; active is Onboarding Request', () => {
    renderAt('/inbox');

    const home = getA(/^home$/i);
    const form = getA(/onboarding form/i);
    const request = getA(/onboarding request/i);

    expect(home).toBeInTheDocument();
    expect(form).toBeInTheDocument();
    expect(request).toBeInTheDocument();

    expect(request).toHaveClass('nav-link-active');
    expect(form).not.toHaveClass('nav-link-active');

    fireEvent.click(home);
    fireEvent.click(request);
    expect(navigateMock).toHaveBeenCalledWith('/home');
    expect(navigateMock).toHaveBeenCalledWith('/inbox');
  });

  test('/inventory-dashboard shows Home + Environment Build Inventory; active is inventory', () => {
    renderAt('/inventory-dashboard');

    const home = getA(/^home$/i);
    const inv = getA(/environment build inventory/i);

    expect(home).toBeInTheDocument();
    expect(inv).toBeInTheDocument();

    expect(inv).toHaveClass('nav-link-active');
    expect(home).not.toHaveClass('nav-link-active');

    fireEvent.click(inv);
    expect(navigateMock).toHaveBeenCalledWith('/inventory-dashboard');
  });

  test('unknown route falls back to default (no nav links) and still renders image', () => {
    renderAt('/unknown/path');

    expect(document.querySelectorAll('a.nav-link').length).toBe(0);
    expect(document.querySelector('.nav-container')).toBeTruthy();
    // alt="" image is still present
    expect(screen.getByRole('img', { name: '' })).toBeInTheDocument();
  });
});
