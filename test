// ====================================================================
// File: src/home/__tests__/Home.test.tsx
// ====================================================================
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import Home from '../Home';

// ---- Minimal, DOM-first MUI mocks (why: deterministic & fast) ----
jest.mock('@mui/material/Box', () => ({
  __esModule: true,
  default: ({ children, ...rest }: any) => <div {...rest}>{children}</div>,
}));
jest.mock('@mui/material/Typography', () => ({
  __esModule: true,
  default: ({ children, ...rest }: any) => <div {...rest}>{children}</div>,
}));
jest.mock('@mui/material/Card', () => ({
  __esModule: true,
  default: ({ children, ...rest }: any) => <div role="article" {...rest}>{children}</div>,
}));
jest.mock('@mui/material/CardContent', () => ({
  __esModule: true,
  default: ({ children, ...rest }: any) => <div {...rest}>{children}</div>,
}));
jest.mock('@mui/material/CardActionArea', () => ({
  __esModule: true,
  default: ({ children, onClick, ...rest }: any) => (
    <button type="button" onClick={onClick} {...rest}>
      {children}
    </button>
  ),
}));
jest.mock('@mui/material/Container', () => ({
  __esModule: true,
  default: ({ children, ...rest }: any) => <div {...rest}>{children}</div>,
}));
jest.mock('@mui/material/Grid', () => ({
  __esModule: true,
  default: ({ children, ...rest }: any) => <div {...rest}>{children}</div>,
}));

// Toolpad PageContainer
jest.mock('@toolpad/core/PageContainer', () => ({
  __esModule: true,
  default: ({ children, ...rest }: any) => <div {...rest}>{children}</div>,
}));

// ---- Router, Config & Services ----
const navigateMock = jest.fn();
jest.mock('react-router-dom', () => ({
  __esModule: true,
  useNavigate: () => navigateMock,
  Link: ({ children, ...p }: any) => <a {...p}>{children}</a>,
}));

jest.mock('@wf/react-library', () => ({
  __esModule: true,
  useConfig: () => ({ env: 'test' }),
}));

jest.mock('../../services/useApiService', () => ({
  __esModule: true,
  default: () => ({ makeRequest: jest.fn() }),
}));

jest.mock('../CustomNavigation', () => ({
  __esModule: true,
  default: () => <nav data-testid="custom-nav">nav</nav>,
}));

// ---- Helpers ----
const getCard = (title: RegExp) =>
  screen.getByRole('button', { name: title });

// ====================================================================
// Tests
// ====================================================================
describe('Home', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  test('renders intro content and all cards', () => {
    render(<Home />);

    // Intro text snippets
    expect(
      screen.getByText(/Welcome to the GCP Tenant Environment Provisioning homepage/i),
    ).toBeInTheDocument();

    // 3 cards (titles + descriptions)
    expect(screen.getByText(/Launch Your Journey in GCP/i)).toBeInTheDocument();
    expect(screen.getByText(/GCP Environment Provision Request/i)).toBeInTheDocument();

    expect(screen.getByText(/GCP Environment Provisioning/i)).toBeInTheDocument();
    expect(screen.getByText(/Provision GCP Infrastructure/i)).toBeInTheDocument();

    expect(screen.getByText(/Environment Build Inventory/i)).toBeInTheDocument();
    expect(
      screen.getByText(/Explore details of environment build inventory/i),
    ).toBeInTheDocument();

    // Images with alt="icon" (one per card)
    expect(screen.getAllByAltText('icon')).toHaveLength(3);

    // Custom nav present
    expect(screen.getByTestId('custom-nav')).toBeInTheDocument();
  });

  test('navigates to /gcpOnboarding when first card is clicked and sets data-active', () => {
    render(<Home />);

    const card1 = getCard(/Launch Your Journey in GCP/i);
    fireEvent.click(card1);

    expect(navigateMock).toHaveBeenCalledWith('/gcpOnboarding');
    expect(card1).toHaveAttribute('data-active', ''); // presence indicates selected
  });

  test('navigates to /provision when second card is clicked', () => {
    render(<Home />);

    const card2 = getCard(/GCP Environment Provisioning/i);
    fireEvent.click(card2);

    expect(navigateMock).toHaveBeenCalledWith('/provision');
  });

  test('navigates to /inventory-dashboard when third card is clicked', () => {
    render(<Home />);

    const card3 = getCard(/Environment Build Inventory/i);
    fireEvent.click(card3);

    expect(navigateMock).toHaveBeenCalledWith('/inventory-dashboard');
  });
});
