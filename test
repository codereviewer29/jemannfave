// src/sideNavbar/boarding/intake-components/gcpComponentIntakeForm.test.tsx
import React from 'react';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { createMemoryRouter, RouterProvider } from 'react-router-dom';

// ---- FormContext mock ----
const setFormData = jest.fn();
const useFormContextMock = jest.fn();

jest.mock('../FormContext', () => ({
  useFormContext: () => useFormContextMock(),
}));

// ---- MUI stubs ----
// Note: TextField is imported from '@mui/material/TextField' so we stub that path too.
jest.mock('@mui/material', () => {
  const React = require('react');
  const Pass = ({ children, ...rest }: any) => <div {...rest}>{children}</div>;
  const Alert = ({ children, severity }: any) => (
    <div role="alert" data-severity={severity}>
      {children}
    </div>
  );
  const Tooltip = ({ title, children }: any) => (
    <div>
      <div data-testid="tooltip-title">{title}</div>
      {children}
    </div>
  );
  const Typography = ({ children }: any) => <div>{children}</div>;
  const Divider = Pass;
  return {
    __esModule: true,
    Box: Pass,
    Grid: Pass,
    Alert,
    Tooltip,
    Typography,
    Divider,
  };
});

jest.mock('@mui/material/TextField', () => {
  const React = require('react');
  return {
    __esModule: true,
    default: ({ label, name, value, onChange, disabled, placeholder }: any) => (
      <label>
        {label}
        <input
          aria-label={label}
          name={name}
          value={value ?? ''}
          placeholder={placeholder}
          disabled={disabled}
          onChange={(e) =>
            onChange?.({ target: { name, value: e.currentTarget.value } })
          }
        />
      </label>
    ),
  };
});

jest.mock('@mui/icons-material/ErrorOutline', () => ({
  __esModule: true,
  default: (props: any) => <span data-testid="error-outline-icon" {...props} />,
}));

// ---- SUT AFTER mocks ----
import GCPComponentIntakeForm from './gcpComponentIntakeForm';

// ---- Helpers ----
function renderWithDataRouter(ui: React.ReactElement) {
  const router = createMemoryRouter([{ path: '/', element: ui }], {
    initialEntries: ['/'],
  });
  return render(<RouterProvider router={router} />);
}

function setup() {
  setFormData.mockClear();

  const baseFormData = {
    gcpComponentDetails: {
      bucketName: '',
      bqDatasetName: '',
    },
  };

  useFormContextMock.mockReturnValue({
    formData: baseFormData,
    setFormData,
    isReadOnly: false,
  });

  const user = userEvent.setup();
  renderWithDataRouter(<GCPComponentIntakeForm validationErrors={{}} />);

  const bucket = screen.getByLabelText(/provide additional bucket name/i);
  const dataset = screen.getByLabelText(/provide additional bq dataset name/i);

  return { user, bucket, dataset, baseFormData };
}

// ---- Tests ----
describe('GCPComponentIntakeForm', () => {
  test('renders static intro text and list items', () => {
    setup();

    expect(
      screen.getByText(/the application data project and cdm next project are key gcp components/i)
    ).toBeInTheDocument();

    // key service names from the static list
    expect(screen.getByText(/gcs \(google cloud storage\) buckets/i)).toBeInTheDocument();
    expect(screen.getByText(/cloud scheduler/i)).toBeInTheDocument();
    expect(screen.getByText(/big query/i)).toBeInTheDocument();
    expect(screen.getByText(/kms keys/i)).toBeInTheDocument();

    // tooltips+icon are present
    expect(screen.getAllByTestId('tooltip-title').length).toBeGreaterThan(0);
    expect(screen.getAllByTestId('error-outline-icon').length).toBeGreaterThan(0);
  });

  test('renders both inputs with placeholders', () => {
    const { bucket, dataset } = setup();

    expect(bucket).toBeInTheDocument();
    expect(bucket).toHaveAttribute('placeholder', expect.stringMatching(/bucket/i));

    expect(dataset).toBeInTheDocument();
    expect(dataset).toHaveAttribute('placeholder', expect.stringMatching(/discriminator/i));
  });

  test('updates formData.gcpComponentDetails.bucketName when typing', async () => {
    const { user, bucket, baseFormData } = setup();

    await user.type(bucket, 'bucket_1');
    expect(setFormData).toHaveBeenLastCalledWith({
      ...baseFormData,
      gcpComponentDetails: {
        ...baseFormData.gcpComponentDetails,
        bucketName: 'bucket_1',
      },
    });
  });

  test('updates formData.gcpComponentDetails.bqDatasetName when typing', async () => {
    const { user, dataset, baseFormData } = setup();

    await user.type(dataset, 'disc_123_appid');
    expect(setFormData).toHaveBeenLastCalledWith({
      ...baseFormData,
      gcpComponentDetails: {
        ...baseFormData.gcpComponentDetails,
        bqDatasetName: 'disc_123_appid',
      },
    });
  });
});
