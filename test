// src/sideNavbar/boarding/intake-components/cdpIntakeForm.test.tsx
import React from 'react';
import { render, screen } from '@testing-library/react';
import { createMemoryRouter, RouterProvider } from 'react-router-dom';

// ---- FormContext mock ----
const useFormContextMock = jest.fn();
jest.mock('../FormContext', () => ({
  useFormContext: () => useFormContextMock(),
}));

// ---- MUI stubs ----
jest.mock('@mui/material', () => {
  const React = require('react');
  const Pass = ({ children, ...rest }: any) => <div {...rest}>{children}</div>;
  const Box = Pass;
  const Grid = Pass;
  const FormControl = Pass;
  const InputLabel = ({ htmlFor, children }: any) => (
    <label htmlFor={htmlFor}>{children}</label>
  );
  const MenuItem = ({ children }: any) => <>{children}</>;
  const Typography = ({ children }: any) => <div>{children}</div>;
  const Tooltip = ({ title, children }: any) => (
    <div>
      <div data-testid="tooltip-title">{title}</div>
      {children}
    </div>
  );
  const Select = ({ label, id, name, value, disabled, children }: any) => {
    const options = React.Children.toArray(children).map((n: any, i: number) => (
      <option key={i} value={n?.props?.value}>
        {n?.props?.children}
      </option>
    ));
    return (
      <label htmlFor={id}>
        {label}
        <select
          id={id}
          name={name}
          aria-label={label}
          value={value ?? ''}
          disabled={disabled}
          onChange={() => {}}
        >
          {options}
        </select>
      </label>
    );
  };
  const Alert = ({ severity, children }: any) => (
    <div role="alert" data-severity={severity}>
      {children}
    </div>
  );
  return {
    __esModule: true,
    Alert,
    Box,
    FormControl,
    Grid,
    InputLabel,
    MenuItem,
    Select,
    Tooltip,
    Typography,
  };
});
jest.mock('@mui/icons-material/Info', () => ({
  __esModule: true,
  default: () => <span data-testid="info-icon" />,
}));

// ---- SUT AFTER mocks ----
import CDPIntakeForm from './cdpIntakeForm';

// ---- helpers ----
function renderWithDataRouter(ui: React.ReactElement) {
  const router = createMemoryRouter([{ path: '/', element: ui }], {
    initialEntries: ['/'],
  });
  return render(<RouterProvider router={router} />);
}
const makeFormData = (dataLoadRequired: string, version = '') => ({
  safeRoomDetails: { dataLoadRequired },
  cdpDetails: { versionCDPRequired: version },
});
function setup(formData: any) {
  const setFormData = jest.fn();
  useFormContextMock.mockReturnValue({ formData, setFormData, isReadOnly: false });
  renderWithDataRouter(<CDPIntakeForm validationErrors={{}} />);
  const select = screen.getByRole('combobox', { name: /which version of cdp is required/i });
  return { select, formData };
}

// ---- tests ----
describe('CDPIntakeForm', () => {
  test('renders overview text and disabled select', () => {
    const { select } = setup(makeFormData('Cloud Storage', 'File to BQ version'));
    expect(screen.getByRole('heading', { name: /cdp overview/i })).toBeInTheDocument();
    expect(
      screen.getByText(/cdp framework streamlines and accelerates cloud migration/i)
    ).toBeInTheDocument();
    expect(select).toBeDisabled();
    // tooltips/icons present
    expect(screen.getAllByTestId('tooltip-title').length).toBeGreaterThan(0);
    expect(screen.getByTestId('info-icon')).toBeInTheDocument();
  });

  test('auto-selects "File to BQ version" when SafeRoom is Cloud Storage', () => {
    const { select } = setup(makeFormData('Cloud Storage', 'File to BQ version'));
    expect(select).toHaveDisplayValue(/file to bq version/i);
  });

  test('auto-selects "BQ to BQ version" when SafeRoom is Big Query', () => {
    const { select } = setup(makeFormData('Big Query', 'BQ to BQ version'));
    expect(select).toHaveDisplayValue(/bq to bq version/i);
  });
});
