// File: src/intake-components/__tests__/CDPIntakeForm.test.tsx
import React from 'react';
import { render, screen, within } from '@testing-library/react';
import userEvent from '@testing-library/user-event';

jest.mock('react-router-dom', () => ({
  ...jest.requireActual('react-router-dom'),
  Form: ({ children, onSubmit }: { children: React.ReactNode; onSubmit?: React.FormEventHandler }) => (
    <form onSubmit={onSubmit}>{children}</form>
  ),
}));

jest.mock('@mui/material', () => {
  const actual = jest.requireActual('@mui/material');
  return {
    ...actual,
    Tooltip: ({ title, children }: { title: React.ReactNode; children: React.ReactElement }) => (
      <div>
        <div data-testid="tooltip-title">{title}</div>
        {children}
      </div>
    ),
  };
});

let ctxFormData: any;
let ctxSetFormData: jest.Mock;
let ctxSetReadOnly: jest.Mock;

jest.mock('../FormContext', () => ({
  useFormContext: () => ({
    formData: ctxFormData,
    setFormData: ctxSetFormData,
    setReadOnly: ctxSetReadOnly,
  }),
}));

import CDPIntakeForm from '../cdpIntakeForm';

function resetCtx(overrides?: Partial<any>) {
  ctxFormData = {
    cdpDetails: { versionCDPRequired: '' },
    safeRoomDetails: { dataLoadRequired: '' },
    ...overrides,
  };
  ctxSetReadOnly = jest.fn();
  ctxSetFormData = jest.fn((next: any) => {
    ctxFormData = typeof next === 'function' ? next(ctxFormData) : next;
  });
}

const renderForm = (validationErrors: Record<string, boolean> = {}) =>
  render(<CDPIntakeForm validationErrors={validationErrors} />);

describe('CDPIntakeForm', () => {
  beforeEach(() => resetCtx());

  test('renders headings, label, and tooltip text', () => {
    renderForm();

    expect(screen.getByText(/CDP Overview/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/Which version of CDP is required/i)).toBeInTheDocument();

    const tip = screen.getByTestId('tooltip-title');
    expect(within(tip).getByText(/Cloud Storage: Both inbound/i)).toBeInTheDocument();
    expect(within(tip).getByText(/Big Query: Inbound data/i)).toBeInTheDocument();
  });

  test('useEffect sets versionCDPRequired for Cloud Storage', () => {
    resetCtx({ safeRoomDetails: { dataLoadRequired: 'Cloud Storage' } });
    renderForm();
    expect(ctxFormData.cdpDetails.versionCDPRequired).toBe('File to BQ version');
  });

  test('useEffect sets versionCDPRequired for Big Query', () => {
    resetCtx({ safeRoomDetails: { dataLoadRequired: 'Big Query' } });
    renderForm();
    expect(ctxFormData.cdpDetails.versionCDPRequired).toBe('BQ to BQ version');
  });

  test('handleChange updates context', async () => {
    const user = userEvent.setup();
    renderForm();

    const select = screen.getByRole('combobox', { name: /Which version of CDP is required/i });
    await user.click(select);
    await user.click(screen.getByRole('option', { name: /File to BQ version/i }));

    expect(ctxSetFormData).toHaveBeenCalled();
    const latest = ctxSetFormData.mock.calls.at(-1)?.[0];
    const newData = typeof latest === 'function' ? latest(ctxFormData) : latest;
    expect(newData.cdpDetails.versionCDPRequired).toBe('File to BQ version');
  });

  test('handleSave success path', async () => {
    const user = userEvent.setup();
    const logSpy = jest.spyOn(console, 'log').mockImplementation(() => {});
    renderForm();

    ctxFormData.cdpDetails.versionCDPRequired = 'File to BQ version';

    await user.click(screen.getByRole('button', { name: /^Save$/i }));

    expect(screen.getByText(/Saferoom Intake details saved Successfully/i)).toBeInTheDocument();
    expect(logSpy).toHaveBeenCalled();
    logSpy.mockRestore();
  });

  test('handleSave shows validation error when missing field', async () => {
    const user = userEvent.setup();
    renderForm();

    await user.click(screen.getByRole('button', { name: /^Save$/i }));

    expect(screen.getByText(/Please complete all required fields before saving/i)).toBeInTheDocument();
  });

  test('handleCancel logs and does not crash', () => {
    const logSpy = jest.spyOn(console, 'log').mockImplementation(() => {});
    renderForm();

    userEvent.click(screen.getByRole('button', { name: /Cancel/i }));
    expect(logSpy).toHaveBeenCalledWith('Form cancelled');
    logSpy.mockRestore();
  });
});
