// File: src/intake-components/__tests__/gcpSaferoomIntakeForm.test.tsx
import React from 'react';
import { render, screen, within } from '@testing-library/react';
import userEvent from '@testing-library/user-event';

jest.mock('react-router-dom', () => ({
  ...jest.requireActual('react-router-dom'),
  Form: ({ children, onSubmit }: { children: React.ReactNode; onSubmit?: React.FormEventHandler }) => (
    <form onSubmit={onSubmit}>{children}</form>
  ),
  Link: ({ children, ...rest }: any) => <a {...rest}>{children}</a>,
}));

jest.mock('@mui/material', () => {
  const actual = jest.requireActual('@mui/material');
  return {
    ...actual,
    Tooltip: ({ title, placement, children }: { title: React.ReactNode; placement?: string; children: React.ReactElement }) => (
      <div data-testid={`tooltip-${placement || 'top'}`}>
        <div data-testid="tooltip-title">{title}</div>
        {children}
      </div>
    ),
  };
});

let ctxFormData: any;
let ctxSetFormData: jest.Mock;
let ctxSetReadOnly: jest.Mock;

jest.mock('../FormContext', () => ({
  useFormContext: () => ({
    formData: ctxFormData,
    setFormData: ctxSetFormData,
    setReadOnly: ctxSetReadOnly,
  }),
}));

import GCPSaferoomIntakeForm from '../gcpSaferoomIntakeForm';

function resetCtx(overrides?: Partial<any>) {
  ctxFormData = {
    gcpSaferoomIntakeId: 0,
    SubmitForSABinding: '',
    SubmitForADBinding: '',
    ...(overrides ?? {}),
  };
  ctxSetReadOnly = jest.fn();
  ctxSetFormData = jest.fn((next: any) => {
    ctxFormData = typeof next === 'function' ? next(ctxFormData) : next;
  });
}

function renderForm(opts?: { intakeFormTrackingId?: number }) {
  const id = opts?.intakeFormTrackingId ?? 0;
  return render(<GCPSaferoomIntakeForm intakeFormTrackingId={id} />);
}

describe('GCPSaferoomIntakeForm', () => {
  beforeEach(() => resetCtx());

  test('renders labels, buttons, and inline help', () => {
    renderForm();

    expect(screen.getByLabelText(/Request Number for SA Role Binding/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/Request Number for AD Group Role Binding/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /Cancel/i })).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /^Save$/i })).toBeInTheDocument();

    const tip = screen.getAllByTestId('tooltip-title')[0];
    expect(within(tip).getByText(/Submit sharepoint intakes for SA role binding/i)).toBeInTheDocument();
  });

  test('saving with empty fields shows validation error alert', async () => {
    const user = userEvent.setup();
    renderForm();

    await user.click(screen.getByRole('button', { name: /^Save$/i }));

    expect(screen.getByText(/Please complete all required fields before saving/i)).toBeInTheDocument();
  });

  test('typing both fields then saving shows success alert and disables actions', async () => {
    const user = userEvent.setup();
    const logSpy = jest.spyOn(console, 'log').mockImplementation(() => {});

    renderForm();

    await user.type(screen.getByLabelText(/Request Number for SA Role Binding/i), 'SA-12345');
    await user.type(screen.getByLabelText(/Request Number for AD Group Role Binding/i), 'AD-67890');

    await user.click(screen.getByRole('button', { name: /^Save$/i }));

    expect(screen.getByText(/GCP Saferoom details saved Successfully/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /^Save$/i })).toBeDisabled();
    expect(screen.getByRole('button', { name: /Cancel/i })).toBeDisabled();

    // Component logs saved data; assert called to confirm success branch
    expect(logSpy).toHaveBeenCalled();
    logSpy.mockRestore();
  });

  test('only one field filled still shows validation error', async () => {
    const user = userEvent.setup();
    renderForm();

    await user.type(screen.getByLabelText(/Request Number for SA Role Binding/i), 'SA-ONLY');
    await user.click(screen.getByRole('button', { name: /^Save$/i }));

    expect(screen.getByText(/Please complete all required fields before saving/i)).toBeInTheDocument();
  });

  test('read-only when intakeFormTrackingId and non-zero existing id', () => {
    resetCtx({ gcpSaferoomIntakeId: 7 });
    renderForm({ intakeFormTrackingId: 100 });

    expect(screen.getByRole('button', { name: /^Save$/i })).toBeDisabled();
  });

  test('handleChange updates context via setFormData', async () => {
    const user = userEvent.setup();
    renderForm();

    await user.type(screen.getByLabelText(/Request Number for SA Role Binding/i), 'X1');

    expect(ctxSetFormData).toHaveBeenCalled();
    const last = ctxSetFormData.mock.calls.at(-1)?.[0];
    const latest = typeof last === 'function' ? last(ctxFormData) : last;
    expect((latest.SubmitForSABinding ?? ctxFormData.SubmitForSABinding)).toContain('X1');
  });
});
